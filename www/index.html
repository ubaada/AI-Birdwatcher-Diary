<html>
<head>
	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<!-- Compiled and minified CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

	<!-- Compiled and minified JavaScript -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<!-- Import jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<body>
	<div class="container">
		<h2>AI Birdwatcher Diary</h2>
		<div class="row">
			<div class="col s12 m8">
				<div class="card">
					<div class="center-align valign-wrapper" style="background-color: rgb(240,240,240); width:100%; height:300px;">
						<img id="bird-img" style ="max-width:100%;height:100%;margin:auto;" src="images/empty-bird.png"/>
					</div>
					<div class="row" style="padding:10px;">
						<form class="col s12" action="upload.php" method="post" enctype="multipart/form-data">
							<!-- Upload Button -->
							<div class="row">
								<div class="col s12">
									<div class="file-field input-field">
										<div class="btn">
											<span>Upload Image to Scan</span>
											<input type="file" id="imgInp" accept="image/x-png, image/gif, image/jpeg, image/jpg" >
										</div>
										<div class="file-path-wrapper">
											<input class="file-path validate" type="text">
										</div>
									</div>
								</div>
							</div>

							<!-- Scientific Name & Common Name Field -->
							<div class="row" id="name_pair">
								
								<div class="col s6">
									<input id="scientific_name" type="text" class="validate">
									<label for="scientific_name">Scientific Name</label>
								</div>
								
								<div class="col s6">
									<input id="common_name" type="text" class="validate">
									<label for="common_name">Common Name</label>
								</div>
							</div>

							<!-- TIme & Location Field -->
							<div class="row">
								<div class="col s6">
									<input id="b_time" type="text" class="validate">
									<label for="b_time">Sighting Time</label>
								</div>
								
								<div class="col s6">
									<input id="b_location" type="text" class="validate">
									<label for="b_location">Sighting Location</label>
								</div>
							</div>

							<!-- Submit button -->
							<div class="row"><div class="col s12 right-align">
								<button class="waves-effect waves-light btn" type="file" name="fileToUpload" id="fileToUpload">
									Submit
									<i class="material-icons right">send</i>
								</button>
							</div></div>
						</form>
					</div>
				</div>
			</div>

			<div class="col s12 m4">
				<div class="card center-align grey-text text-darken-1 z-depth-0" style="background-color: rgb(240,240,240);padding:3px;">
					<p>History</p>
				</div>
				<div id ="all_birds">
				</div>
			</div>
		</div>
	</div>
</div>
<script>

	// Display the selected img and Classify it.
	$("#imgInp").change(function(){

		readURL(this);
		send_img_to_classifier();
	});
	
	// Display the user-selected image in the box
	function readURL(input) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();

			reader.onload = function (e) {
				$('#bird-img').attr('src', e.target.result);
			}

			reader.readAsDataURL(input.files[0]);
		}
	}


	// Send the bird image to /which-bird.php to classify it.
	function send_img_to_classifier() {
		// Clear text fields
		$("#scientific_name").val("");
		$("#common_name").val("");

		var file_data = $('#imgInp').prop('files')[0];   
		var form_data = new FormData();                  
		form_data.append('file', file_data);
		$.ajax({
			url: "which-bird.php",
			type: "POST",
			data: form_data,
			contentType: false,
			cache: false,
			processData:false,
			success: function(data){
				// Result received from server
				console.log(data);
				var c = data.split(",");

				// Check if the image is of a bird or not
				if (c[0].valueOf() != "background".valueOf()) {
					// Set text fields to received names
					$("#scientific_name").val(c[0]);
					$("#common_name").val(c[1]);
					if (c[2] < 0.4) {
						var msg ='Not super sure about that :/<br>Maybe its not one of species our system is able to detect?';
						M.toast({html: msg,displayLength:10000,classes: 'rounded'});
					} else {
						M.toast({html: 'Successful',displayLength:4000,classes: 'teal rounded'});	
					}
				} else {
					var msg = 'Could not identify the specie.<br>Are you sure that is a bird?';
					M.toast({html: msg, displayLength:5000,classes: 'red rounded' })
				}	
			}
		});
		
	}

	// Load previous record upon document load.
	$( document ).ready(function() {
	    set_all_birds();
	});


	// Gets previous bird sighting entries from get_all.php
	function set_all_birds() {
		$.ajax({
			url: "get_all.php",
			type: "GET",
			success: function(data){
				// Result received from server
				$("#all_birds").html(data);
			}
		});
	}
</script>
</body>

</html>